steps:
- script: |
    set -e
    sudo apt-get update
    sudo apt-get install -y libx11-dev libxkbfile-dev pkg-config libsecret-1-dev libxss1 dbus xvfb libgtk-3-0
#    sudo cp build/azure-pipelines/linux/xvfb.init /etc/init.d/xvfb
#    sudo chmod +x /etc/init.d/xvfb
#    sudo update-rc.d xvfb defaults
#    sudo service xvfb start
  displayName: apt-get install dependencies

# https://nodejs.org/dist/index.json
# https://github.com/Microsoft/azure-pipelines-tasks/blob/master/Tasks/NodeToolV0/nodetool.ts
- task: NodeTool@0
  inputs:
    versionSpec: "8.15.0"
- script: |
    npm install -g yarn
  displayName: Install yarn with npm
- script: |
    #which node
    #node --version
    echo ===================== debug node build native errors common.gypi electron 3.0.13 ===================================
    yarn add native-watchdog@1.0.0
    cat ~/.node-gyp/iojs-3.0.13/common.gypi
    yarn
  displayName: Install Dependencies
#- script: |
#    yarn gulp electron-${VSCODE_ARCH}
#  displayName: Download Electron

- script: |
    export npm_config_arch="${VSCODE_ARCH}"
    if [[ "$(VSCODE_ARCH)" == "ia32" ]]; then
      export PKG_CONFIG_PATH="/usr/lib/i386-linux-gnu/pkgconfig"
    fi
    ARCH="${VSCODE_ARCH}"
    set
    yarn gulp vscode-linux-${VSCODE_ARCH}-min
    yarn gulp vscode-linux-${VSCODE_ARCH}-build-rpm
    yarn gulp vscode-linux-${VSCODE_ARCH}-build-deb
  displayName: "Linux build $(VSCODE_ARCH) rpm and deb"

- script: |
    ./upload_bintray_linux.sh
  env:
    BINTRAY_API_KEY: $(BINTRAY_API_KEY)
  displayName: "upload eShell linux $(VSCODE_ARCH)"
