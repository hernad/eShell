steps:
- task: NodeTool@0
  inputs:
    versionSpec: "12.14.0"
- powershell: |
    npm install -g yarn
  displayName: hernad - Install yarn with npm
- task: UsePythonVersion@0
  inputs:
    versionSpec: '2.x'
    addToPath: true
- powershell: |
    . build/azure-pipelines/win32/exec.ps1
    $ErrorActionPreference = "Stop"
    # 32-bit build
    $env:npm_config_arch="$(VSCODE_ARCH)"
    $env:CHILD_CONCURRENCY="1"
    exec { yarn }
    # exec { npm run gulp -- hygiene }
    # exec { npm run monaco-compile-check }
    # exec { npm run strict-null-check }
    # exec { npm run gulp -- mixin }
    # exec { node build/azure-pipelines/common/installDistro.js }
    # exec { node build/lib/builtInExtensions.js }
  displayName: yarn prep

- powershell: |
    npx gulp vscode-win32-$(VSCODE_ARCH)-min
    npx gulp vscode-win32-$(VSCODE_ARCH)-inno-updater
    npx gulp vscode-win32-$(VSCODE_ARCH)-user-setup
    # npx gulp vscode-win32-ia32-archive
  displayName: "win32-32bit build $(VSCODE_ARCH) zip"

- script: |
    git clone https://github.com/lazka/msys2-ci-base.git %CD:~0,2%\msys64
    %CD:~0,2%\msys64\usr\bin\rm -rf %CD:~0,2%\msys64\.git
    set PATH=%CD:~0,2%\msys64\usr\bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem
    %CD:~0,2%\msys64\usr\bin\pacman --noconfirm -Syyuu
    %CD:~0,2%\msys64\usr\bin\sed -i "s|#CacheDir.*|CacheDir=/c/Users/%USERNAME%/AppData/Local/Temp|g" /etc/pacman.conf
    %CD:~0,2%\msys64\usr\bin\bash -lc "bash upload_bintray_win32.sh"
  displayName: upload to bintray eShell windows 32-bit
  env:
    CHERE_INVOKING: yes
    BINTRAY_API_KEY: $(BINTRAY_BRINGOUT_API_KEY)
