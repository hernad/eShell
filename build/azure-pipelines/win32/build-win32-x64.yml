steps:
- task: NodeTool@0
  inputs:
    versionSpec: "12.14.0"
- powershell: |
    npm install -g yarn
  displayName: hernad - Install yarn with npm
- task: UsePythonVersion@0
  inputs:
    versionSpec: '2.x'
    addToPath: true

- powershell: |
    . build/azure-pipelines/win32/exec.ps1
    $ErrorActionPreference = "Stop"
    # 64-bit build
    $env:npm_config_arch="$(VSCODE_ARCH)"
    $env:CHILD_CONCURRENCY="1"
    # $env:VSCODE_MIXIN_PASSWORD="$(VSCODE_MIXIN_PASSWORD)"
    exec { yarn }
    # exec { npm run gulp -- hygiene }
    #exec { npm run monaco-compile-check }
    #exec { npm run strict-null-check }
    #exec { npm run gulp -- mixin }
    #exec { node build/azure-pipelines/common/installDistro.js }
    #exec { node build/lib/builtInExtensions.js }
  displayName: yarn prep

- powershell: |
    . build/azure-pipelines/win32/exec.ps1
    $ErrorActionPreference = "Stop"
    exec { yarn gulp "compile-build" }
    exec { yarn gulp "compile-extensions-build" }
    exec { yarn gulp "minify-vscode" }
    exec { yarn gulp "vscode-win32-$env:VSCODE_ARCH-min-ci" }
    exec { yarn gulp "vscode-win32-$env:VSCODE_ARCH-code-helper" }
    exec { yarn gulp "vscode-win32-$env:VSCODE_ARCH-inno-updater" }
    exec { yarn gulp "vscode-win32-$env:VSCODE_ARCH-archive" "vscode-win32-$env:VSCODE_ARCH-user-setup" }
  displayName: "win32 build $(VSCODE_ARCH) zip"

- script: |
    git clone https://github.com/lazka/msys2-ci-base.git %CD:~0,2%\msys64
    %CD:~0,2%\msys64\usr\bin\rm -rf %CD:~0,2%\msys64\.git
    set PATH=%CD:~0,2%\msys64\usr\bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem
    %CD:~0,2%\msys64\usr\bin\pacman --noconfirm -Syyuu
    %CD:~0,2%\msys64\usr\bin\sed -i "s|#CacheDir.*|CacheDir=/c/Users/%USERNAME%/AppData/Local/Temp|g" /etc/pacman.conf
    %CD:~0,2%\msys64\usr\bin\bash -lc "bash upload_bintray_win32.sh"
  displayName: upload to bintray eShell windows 64-bit
  env:
    CHERE_INVOKING: yes
    BINTRAY_API_KEY: $(BINTRAY_BRINGOUT_API_KEY)
